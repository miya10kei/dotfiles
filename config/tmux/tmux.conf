set-option -g @TMUX_HOME "$HOME/.config/tmux"

# ==================================================
# PLUGIN INSTALLATION
# ==================================================
if-shell "test ! -d #{@TMUX_HOME}/plugins/tpm" \
   "run-shell 'git clone https://github.com/tmux-plugins/tpm #{@TMUX_HOME}/plugins/tpm'"

set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'catppuccin/tmux'
set -g @plugin 'tmux-plugins/tmux-resurrect'
set -g @plugin 'tmux-plugins/tmux-yank'
set -g @plugin 'tmux-plugins/tmux-cpu'

if-shell "test -d #{@TMUX_HOME}/plugins/tpm && test ! -d #{@TMUX_HOME}/plugins/tmux" \
   "run-shell '#{@TMUX_HOME}/plugins/tpm/bin/install_plugins'"


# ==================================================
# BASIC SETTINGS
# ==================================================
set -s escape-time 50
set -g default-shell "${SHELL}"
set -g default-command "${SHELL}"
set -g default-terminal "tmux-256color"
set -ag terminal-overrides ",*:Tc"
set -s set-clipboard on
set -s allow-passthrough on
set -g focus-events on
set -g base-index 1
set -g pane-base-index 1
set -g renumber-windows on
set -g history-limit 10000


# ==================================================
# KEY BINDINGS
# ==================================================
# Prefix
unbind-key C-b
set -g prefix C-g
bind C-g send-prefix

# Reload
bind r source-file "$HOME/.config/tmux/tmux.conf" \; display-message 'Reload tmux.conf'

# Pane navigation
bind h select-pane -L
bind j select-pane -D
bind k select-pane -U
bind l select-pane -R
bind 1 select-pane -t 1
bind 2 select-pane -t 2
bind 3 select-pane -t 3
bind 4 select-pane -t 4
bind 5 select-pane -t 5
bind 6 select-pane -t 6
bind 7 select-pane -t 7
bind 8 select-pane -t 8
bind 9 select-pane -t 9

# Pane resize
bind -r H resize-pane -L 5
bind -r J resize-pane -D 5
bind -r K resize-pane -U 5
bind -r L resize-pane -R 5

# Window/Pane split
bind | split-window -dh -c "#{pane_current_path}"
bind - split-window -dv -c "#{pane_current_path}" -l 1

# Utilities
bind q kill-window
bind e setw synchronize-panes on
bind E setw synchronize-panes off


# ==================================================
# MOUSE & COPY MODE
# ==================================================
set -g mouse on
bind -n WheelUpPane if-shell -F -t = "#{mouse_any_flag}" "send-keys -M" "if -Ft= '#{pane_in_mode}' 'send-keys -M' 'copy-mode -e'"
bind -n WheelDownPane select-pane -t= \; send-keys -M

set -g mode-keys vi
bind -T copy-mode-vi v send -X begin-selection
bind -T copy-mode-vi V send -X select-line
bind -T copy-mode-vi y send -X copy-pipe-and-cancel 'xsel -bi'
bind -T copy-mode-vi MouseDragEnd1Pane send -X copy-pipe-and-cancel 'xsel -bi'


# ==================================================
# EXTERNAL INTEGRATIONS
# ==================================================
# navi
bind g display-popup -w 95% -h 80% \
  "$SHELL --login -i -c 'navi --print | head -n 1 | tmux load-buffer -b tmp - ; tmux paste-buffer -p -t {last} -b tmp -d'"

# popup
bind m run-shell 'zsh --login -i -c "tmux_popup"'

# dev layout
bind D run-shell 'zsh --login -i -c "tmux_dev_layout"'

# fzf pane selector
bind P display-popup -w 80% -h 60% -E "tmux list-panes -a -F '#{session_name}:#{window_index}.#{pane_index} #{pane_current_command} #{pane_current_path}' | fzf --reverse | awk '{print \$1}' | xargs tmux switch-client -t"


# ==================================================
# PLUGIN SETTINGS
# ==================================================
# catppuccin
set -g @catppuccin_flavor "mocha"
set -g @catppuccin_window_status_style "rounded"
set -g @catppuccin_window_text " #W"
set -g @catppuccin_window_current_text " #W"

run "#{@TMUX_HOME}/plugins/tmux/catppuccin.tmux"

source -F "#{@TMUX_HOME}/host.conf"
source -F "#{@TMUX_HOME}/memory.conf"

# ==================================================
# STATUS BAR
# ==================================================
set -g status on
set -g status-interval 1
set -g status-position top
set -g status-left ""
set -g status-right-length 200
set -g status-right "#{E:@catppuccin_status_host}"
set -ag status-right "#{E:@catppuccin_status_session}"
set -ag status-right "#{E:@catppuccin_status_application}"
set -agF status-right "#{E:@catppuccin_status_cpu}"
set -agF status-right "#{E:@catppuccin_status_memory}"


# ==================================================
# TPM INITIALIZATION
# ==================================================
run "#{@TMUX_HOME}/plugins/tpm/tpm"


# ==================================================
# THEME-DEPENDENT SETTINGS (Load after TPM)
# ==================================================
# Pane border
set -g pane-border-status top
set -g pane-border-format " #P: #T "
set -g pane-border-lines double
set -gF pane-active-border-style "fg=#{@thm_green}"
set -gF pane-border-style "fg=#{@thm_overlay_0}"

# Copy mode: change border color to yellow
set-hook -g pane-mode-changed \
    'if-shell -F "#{pane_in_mode}" \
        "set -gF pane-active-border-style \"fg=#{@thm_yellow}\"" \
        "set -gF pane-active-border-style \"fg=#{@thm_green}\""'

# Pane focus: cancel copy mode and reset border color
set-hook -g pane-focus-out \
    'if-shell -F "#{pane_in_mode}" \
        "send-keys -X cancel; set -gF pane-active-border-style \"fg=#{@thm_green}\"" \
        ""'
