# --------------------------------------------------
# Basic
# --------------------------------------------------
set -s escape-time 50

set-option -g default-shell "${SHELL}"
set -g default-command "${SHELL}"
set -g  default-terminal "tmux-256color"
set -ag terminal-overrides ",*:Tc"
set -s  set-clipboard on
set -g  focus-events on

set  -g  base-index 1
setw -g  pane-base-index 1
set  -g  renumber-windows on
set-option -g history-limit 10000

# Pane border
set -g pane-border-status top
set -g pane-border-format " #P: #T "


# --------------------------------------------------
# Statusbar
# --------------------------------------------------
set-option -g status on
set-option -g status-interval 1
set-option -g status-position top
set-option -g status-left ""

# --------------------------------------------------
# Keybind
# --------------------------------------------------
unbind-key C-b
set-option -g prefix C-g
bind-key C-g send-prefix

bind r source-file $HOME/.tmux.conf \; display-message 'Reload .tmux.conf'

bind e setw synchronize-panes on
bind E setw synchronize-panes off

bind h select-pane -L
bind j select-pane -D
bind k select-pane -U
bind l select-pane -R

bind -r H resize-pane -L 5
bind -r J resize-pane -D 5
bind -r K resize-pane -U 5
bind -r L resize-pane -R 5

bind | split-window -dh -c "#{pane_current_path}"
bind - split-window -dv -c "#{pane_current_path}" -l 1

bind q kill-window

bind 1 select-pane -t 1
bind 2 select-pane -t 2
bind 3 select-pane -t 3
bind 4 select-pane -t 4
bind 5 select-pane -t 5
bind 6 select-pane -t 6
bind 7 select-pane -t 7
bind 8 select-pane -t 8
bind 9 select-pane -t 9


# --------------------------------------------------
# Mouse
# --------------------------------------------------
set-option -g mouse on

bind -n WheelUpPane   if-shell -F -t = "#{mouse_any_flag}" "send-keys -M" "if -Ft= '#{pane_in_mode}' 'send-keys -M' 'copy-mode -e'"
bind -n WheelDownPane select-pane -t= \; send-keys -M


# --------------------------------------------------
# Copy
# --------------------------------------------------
setw -g mode-keys vi
bind -T copy-mode-vi v send -X begin-selection
bind -T copy-mode-vi V send -X select-line
bind -T copy-mode-vi y send -X copy-pipe-and-cancel 'xsel -bi'
bind -T copy-mode-vi MouseDragEnd1Pane send -X copy-pipe-and-cancel 'xsel -bi'

# --------------------------------------------------
# navi
# --------------------------------------------------
bind g display-popup -w 95% -h 80% \
  "$SHELL --login -i -c 'navi --print | head -n 1 | tmux load-buffer -b tmp - ; tmux paste-buffer -p -t {last} -b tmp -d'"

# --------------------------------------------------
# popup
# --------------------------------------------------
bind m run-shell 'zsh --login -i -c "tmux_popup"'

# --------------------------------------------------
# dev layout
# --------------------------------------------------
bind D run-shell 'zsh --login -i -c "tmux_dev_layout"'


# --------------------------------------------------
# Plugin
# --------------------------------------------------
set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'catppuccin/tmux'
set -g @plugin 'tmux-plugins/tmux-resurrect'
set -g @plugin 'tmux-plugins/tmux-yank'
set -g @plugin 'tmux-plugins/tmux-cpu'
set -g @plugin 'olimorris/tmux-pomodoro-plus'

# --------------------------------------------------
# catppuccin
# --------------------------------------------------
set -g @catppuccin_flavor "mocha"
set -g @catppuccin_window_status_style "rounded"
set -g @catppuccin_window_text " #W"
set -g @catppuccin_window_current_text " #W"

# Load catppuccin (TPMより先にロード)
run "$HOME/.tmux/plugins/tmux/catppuccin.tmux"


# Custom memory module (catppuccin読み込み後に定義)
%hidden MODULE_NAME="memory"
set -g "@catppuccin_${MODULE_NAME}_icon" "󰍛 "
set -gF "@catppuccin_${MODULE_NAME}_color" "#{E:@thm_green}"
set -g "@catppuccin_${MODULE_NAME}_text" " #{l:#{ram_percentage}}"
source "$HOME/.tmux/plugins/tmux/utils/status_module.conf"

# pomodoro_plus icon fix
set -g "@catppuccin_pomodoro_plus_icon" " "
set -g @pomodoro_on "󰔟 "
set -g @pomodoro_complete " "
set -g @pomodoro_pause "󰏤 "
set -g @pomodoro_prompt_break "  break?"
set -g @pomodoro_prompt_pomodoro " start?"
set -g @pomodoro_granularity 'on'
set -g @pomodoro_interval_display "[%s/%s]"

# --------------------------------------------------
# Statusbar modules
# --------------------------------------------------
set -g   status-right "#{E:@catppuccin_status_session}"
set -ag  status-right "#{E:@catppuccin_status_application}"
set -agF status-right "#{E:@catppuccin_status_cpu}"
set -agF status-right "#{E:@catppuccin_status_memory}"
set -agF status-right "#{E:@catppuccin_status_pomodoro_plus}"

# --------------------------------------------------
# tpm
# --------------------------------------------------
run "$HOME/.tmux/plugins/tpm/tpm"

# --------------------------------------------------
# Pane border style (TPMより後にロード)
# --------------------------------------------------
set -g pane-border-lines double
set -gF pane-active-border-style "fg=#{@thm_green}"
set -gF pane-border-style "fg=#{@thm_surface_0}"

# Copy mode時にpane borderを黄色に変更
set-hook -g pane-mode-changed \
    "run-shell 'if [ \"#{pane_in_mode}\" = \"1\" ]; then \
        tmux set -gF pane-active-border-style \"fg=#{@thm_yellow}\"; \
    else \
        tmux set -gF pane-active-border-style \"fg=#{@thm_green}\"; \
    fi'"
